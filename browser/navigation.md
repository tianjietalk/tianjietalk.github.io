# 输入 URL 到页面展示

![img](assets/92d73c75308e50d5c06ad44612bcb45d.png)

## 用户输入 URL

用户输入 URL 后，当前页面要被替换成新的页面，在此之前，浏览器执行`beforeunload`事件执行数据清理操作，有时需要询问用户是否要离开。

## URL 请求过程

1. 网络进程查找本地缓存，是否有页面资源缓存。
   1. 有缓存，返回资源给浏览器进程。
   2. 没有缓存，进入网络请求流程。
2. 查找 DNS 缓存。
   1. 有缓存，获取请求域名的 IP 地址。
   2. 没有缓存，向 DNS 发送请求，获取 IP 地址。
3. 根据 IP 和端口号，建立 TCP 连接。
   1. 如果请求协议是 HTTPS，需要建立 TLS 连接。
   2. 用一域名同时最多建立 6 个 TCP 连接，看你需要等待。
4. 浏览器发送请求信息。
5. 服务器生成响应数据，发送给网络进程，网络进程解析响应内容。
   1. 重定向。返回状态码是 301 或 302，需要重定向到其他 URL，根据`Location`字段获取重定向地址，重新发起新的 HTTP/HTTPS 请求。
   2. 服务器根据`If-None-Match`字段值，返回 304，浏览器的缓存可以使用，从缓存中取资源。
   3. 返回 200，处理响应数据类型。根据`Content-Type`值，确定响应体的数据类型。
      1. 字段值是`text/html`说明返回数据是 HTML 格式。
      2. `application/octet-stream`说明是字节流类型，浏览器按下载类型处理请求。
      3. 如果是下载类型，URL 导航流程结束。如果是 HTML，会继续接下来的流程。
6. TCP 断开连接。
   1. 如果响应头或请求头有`Connection:keep-alive`字段，不会断开连接。
7. 准备渲染流程。
   1. 一般情况下，每个页面会有单独的渲染进程。
   2. 当多个页面属于同一站点（同根域名和协议相同）时，只会有一个渲染进程，新页面会复用老页面的渲染进程。
8. 准备流程结束后，浏览器进程将 HTML 数据提交给渲染进程。
9. 渲染进程解析页面和子资源，将页面显示出来。
   1. HTML 解析器解析出 DOM 树。
   2. CSS 解释器解析出 CSSOM 树。
   3. 结合两个树得到 render tree，通过 Layout 计算每个元素的宽高颜色位置，绘制元素。
